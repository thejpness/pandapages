services:
  postgres:
    image: postgres:18.1-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: pandapages
      POSTGRES_USER: pandapages
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pandapages -d pandapages"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [internal]
    labels:
      - traefik.enable=false

  migrate:
    build:
      context: ./apps/api
      target: migrate
    restart: "no"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./apps/api/migrations:/migrations:ro
    networks: [internal]
    labels:
      - traefik.enable=false
    # migrate image ENTRYPOINT is goose; just pass args
    command: ["-dir", "/migrations", "postgres", "${DATABASE_URL}", "up"]

  api:
    build:
      context: ./apps/api
      target: prod
      args:
        API_MAIN: ./cmd/api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: ${DATABASE_URL}
      PP_ASSET_DIR: /data/assets
      PP_LOG_LEVEL: ${PP_LOG_LEVEL:-info}
      PP_PASSCODE: ${PP_PASSCODE}
      PP_SESSION_SECRET: ${PP_SESSION_SECRET}
      PP_ADMIN_KEY: ${PP_ADMIN_KEY}
    volumes:
      - assets:/data/assets
    networks: [traefik, internal]
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik

      - traefik.http.services.pandapages-api.loadbalancer.server.port=8080

      # Admin API: inject header here (browser never sees key)
      - traefik.http.routers.pandapages-api-admin.rule=(Host(`panda-pages.com`) || Host(`www.panda-pages.com`)) && PathPrefix(`/api/v1/admin/`)
      - traefik.http.routers.pandapages-api-admin.entrypoints=websecure
      - traefik.http.routers.pandapages-api-admin.tls=true
      - traefik.http.routers.pandapages-api-admin.tls.certresolver=myresolver
      - traefik.http.routers.pandapages-api-admin.priority=200
      - traefik.http.routers.pandapages-api-admin.service=pandapages-api
      - traefik.http.routers.pandapages-api-admin.middlewares=pandapages-admin-ips@docker,pandapages-admin-key@docker

      # Optional allowlist (defaults to allow-all if PP_ADMIN_IPS not set)
      - traefik.http.middlewares.pandapages-admin-ips.ipallowlist.sourcerange=${PP_ADMIN_IPS:-0.0.0.0/0,::/0}

      # Inject admin header server-side
      - traefik.http.middlewares.pandapages-admin-key.headers.customrequestheaders.X-PP-Admin-Key=${PP_ADMIN_KEY}

      # Public API
      - traefik.http.routers.pandapages-api.rule=(Host(`panda-pages.com`) || Host(`www.panda-pages.com`)) && (PathPrefix(`/api`) || PathPrefix(`/healthz`))
      - traefik.http.routers.pandapages-api.entrypoints=websecure
      - traefik.http.routers.pandapages-api.tls=true
      - traefik.http.routers.pandapages-api.tls.certresolver=myresolver
      - traefik.http.routers.pandapages-api.priority=100
      - traefik.http.routers.pandapages-api.service=pandapages-api

  web:
    build:
      context: ./apps/web
      target: prod
      args:
        VITE_API_BASE: ""
        VITE_ADMIN_KEY: ""
    restart: unless-stopped
    depends_on: [api]
    networks: [traefik]
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.services.pandapages-web.loadbalancer.server.port=80
      - traefik.http.routers.pandapages-web.rule=(Host(`panda-pages.com`) || Host(`www.panda-pages.com`)) && !PathPrefix(`/api`) && !PathPrefix(`/healthz`)
      - traefik.http.routers.pandapages-web.entrypoints=websecure
      - traefik.http.routers.pandapages-web.tls=true
      - traefik.http.routers.pandapages-web.tls.certresolver=myresolver
      - traefik.http.routers.pandapages-web.priority=10

networks:
  traefik:
    external: true
  internal:
    driver: bridge

volumes:
  pgdata: {}
  assets: {}